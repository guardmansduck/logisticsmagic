name: Build IPA Only

on:
  workflow_dispatch:
    inputs:
      scheme:
        description: 'Select Xcode scheme'
        required: true
        default: 'YourApp'
      generate_ipa:
        description: 'Generate downloadable IPA?'
        required: true
        default: 'true'
        type: boolean

jobs:
  build-ipa:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Remove Guide folder
      - name: Remove Guide folder
        run: |
          if [ -d "./Guide" ]; then
            echo "Removing Guide folder from build..."
            rm -rf ./Guide
          fi

      # 3️⃣ Set up Xcode
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v2
        with:
          xcode-version: '15.2'

      # 4️⃣ Install Swift packages
      - name: Install Swift Packages
        run: swift package resolve

      # 5️⃣ Build and Archive
      - name: Build and Archive App
        run: |
          xcodebuild -workspace YourApp.xcworkspace \
                     -scheme ${{ github.event.inputs.scheme }} \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath $PWD/build/${{ github.event.inputs.scheme }}.xcarchive archive

      # 6️⃣ Generate ExportOptions.plist
      - name: Generate ExportOptions.plist
        run: |
          PLIST_PATH="$PWD/build/ExportOptions.plist"
          cat <<EOF > $PLIST_PATH
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>compileBitcode</key>
  <false/>
  <key>method</key>
  <string>ad-hoc</string> <!-- or "development" / "enterprise" -->
  <key>signingStyle</key>
  <string>manual</string>
  <key>stripSwiftSymbols</key>
  <true/>
  <key>uploadSymbols</key>
  <true/>
  <key>uploadBitcode</key>
  <true/>
</dict>
</plist>
EOF

      # 7️⃣ Export IPA
      - name: Export .ipa
        if: ${{ github.event.inputs.generate_ipa == 'true' }}
        run: |
          xcodebuild -exportArchive \
                     -archivePath $PWD/build/${{ github.event.inputs.scheme }}.xcarchive \
                     -exportPath $PWD/build \
                     -exportOptionsPlist $PWD/build/ExportOptions.plist

      # 8️⃣ Upload IPA as artifact
      - name: Upload .ipa Artifact
        if: ${{ github.event.inputs.generate_ipa == 'true' }}
        uses: actions/upload-artifact@v3
        with:
          name: iOS-App
          path: build/${{ github.event.inputs.scheme }}.ipa
